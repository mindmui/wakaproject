<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>WAKA Project - Waka Membership</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-MZDWS9HT55"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-MZDWS9HT55');
        </script>
        <!-- Firebase SDK Version 8 (compatible with HTML files without modules) -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

          <script>
            // Replace with your own Firebase configuration
              const firebaseConfig = {
                apiKey: "AIzaSyBTSgKRGTqOw28xjZrnr4efEwS7aqJvNQA",
                authDomain: "wakaproject-membership.firebaseapp.com",
                projectId: "wakaproject-membership",
                storageBucket: "wakaproject-membership.firebasestorage.app",
                messagingSenderId: "298596177389",
                appId: "1:298596177389:web:f0402d6ff0ce34af0743e4",
                measurementId: "G-HQZL3STV40"
              };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
          </script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-white">
            <div class="container px-4 px-lg-5">
                
                <a class="navbar-brand" href="#!"><img src="assets/logo-white.jpg" class="navbar-brand" style="height: 55px"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><a class="nav-link" aria-current="page" href="./index.html">Pokemon</a></li>
                        <!-- <li class="nav-item"><a class="nav-link" href="./youngguns">Young Guns</a></li> -->
                        <li class="nav-item"><a class="nav-link" href="./bot">BoT</a></li>
                        <li class="nav-item"><a class="nav-link" href="./rewards.html">Rewards</a></li>
                        <li class="nav-item"><a class="nav-link active" href="./register.html">Register</a></li>
                        <!-- <li class="nav-item"><a class="nav-link" href="./contact">Contact</a></li> -->
                    </ul>

                     <span class="mytooltip tooltip-effect-1">
                        <span class="tooltip-item">
                            <a href="https://line.me/ti/g2/ESxNt_nMsHA83nov78pwfmxU8mxeQG7Hz2mc7A?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank">  
                                <button class="btn btn-outline-dark" type="submit">
                                Join Us
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-line" viewBox="0 0 16 16">
                                      <path d="M8 0c4.411 0 8 2.912 8 6.492 0 1.433-.555 2.723-1.715 3.994-1.678 1.932-5.431 4.285-6.285 4.645-.83.35-.734-.197-.696-.413l.003-.018.114-.685c.027-.204.055-.521-.026-.723-.09-.223-.444-.339-.704-.395C2.846 12.39 0 9.701 0 6.492 0 2.912 3.59 0 8 0ZM5.022 7.686H3.497V4.918a.156.156 0 0 0-.155-.156H2.78a.156.156 0 0 0-.156.156v3.486c0 .041.017.08.044.107v.001l.002.002.002.002a.154.154 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157Zm.791-2.924a.156.156 0 0 0-.156.156v3.486c0 .086.07.155.156.155h.562c.086 0 .155-.07.155-.155V4.918a.156.156 0 0 0-.155-.156h-.562Zm3.863 0a.156.156 0 0 0-.156.156v2.07L7.923 4.832a.17.17 0 0 0-.013-.015v-.001a.139.139 0 0 0-.01-.01l-.003-.003a.092.092 0 0 0-.011-.009h-.001L7.88 4.79l-.003-.002a.029.029 0 0 0-.005-.003l-.008-.005h-.002l-.003-.002-.01-.004-.004-.002a.093.093 0 0 0-.01-.003h-.002l-.003-.001-.009-.002h-.006l-.003-.001h-.004l-.002-.001h-.574a.156.156 0 0 0-.156.155v3.486c0 .086.07.155.156.155h.56c.087 0 .157-.07.157-.155v-2.07l1.6 2.16a.154.154 0 0 0 .039.038l.001.001.01.006.004.002a.066.066 0 0 0 .008.004l.007.003.005.002a.168.168 0 0 0 .01.003h.003a.155.155 0 0 0 .04.006h.56c.087 0 .157-.07.157-.155V4.918a.156.156 0 0 0-.156-.156h-.561Zm3.815.717v-.56a.156.156 0 0 0-.155-.157h-2.242a.155.155 0 0 0-.108.044h-.001l-.001.002-.002.003a.155.155 0 0 0-.044.107v3.486c0 .041.017.08.044.107l.002.003.002.002a.155.155 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156Z"/>
                                    </svg>
                                </button>
                            </a>
                        </span>
                        <span class="tooltip-content clearfix">
                            <img src="assets/QrCode.jpg" loading="lazy">
                        </span>
                     </span>
                  
        
                </div>
            </div>
        </nav>

  
        <!-- Section 1-->
        <section class="py-5 bg-light gallery">
                    <div class="col-md-12 text-center">
                        
                        <h1 class="display-5 fw-bolder">Waka Membership</h1>

                          <div class="container my-5">
                            <div class="row justify-content-center">

                              <div class="col-md-8 col-lg-6">
                                <div class="card shadow-lg">
                                  <div class="card-body">
                                    <h2 class="card-title text-center mb-4">Your Profile</h2>
                                    
                                    <!-- Display Profile Details -->
                                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                                    <p><strong>Full Name:</strong> <span id="displayName"></span></p>
                                    <p><strong>AKA:</strong> <span id="displayAka"></span></p>
                                    <p><strong>Points:</strong> <span id="userPoints"></span></p>
                                    
                                    <!-- Update Profile Name and AKA -->
                                    <h5 class="mt-4">Update Profile Details</h5>
                                    <form id="updateProfileForm" class="mb-3">
                                      <input type="text" class="form-control mb-2" id="profileName" placeholder="New Full Name" required>
                                      <input type="text" class="form-control mb-2" id="profileAka" placeholder="New AKA" required>
                                      <button type="submit" class="btn btn-primary w-100">Update Profile</button>
                                    </form>
                                    
                                    <!-- Change Password -->
                                    <h5>Change Password</h5>
                                    <form id="changePasswordForm" class="mb-3">
                                          <input type="password" class="form-control mb-2" id="currentPassword" placeholder="Current Password" required>
                                          <input type="password" class="form-control mb-2" id="newPassword" placeholder="New Password" required>
                                          <div class="invalid-feedback" id="passwordLengthError" style="display: none;">Password must be at least 6 characters.</div>
                                          <input type="password" class="form-control mb-2" id="confirmNewPassword" placeholder="Confirm New Password" required>
                                          <div class="invalid-feedback" id="passwordMatchError" style="display: none;">New passwords do not match.</div>
                                          <button type="submit" class="btn btn-secondary w-100">Change Password</button>
                                        </form>
                                    
                                    <button id="logout" class="btn btn-danger w-100 mt-4">Log Out</button>
                                  </div>
                                </div>
                              </div>


                              <!-- Point History Card with Pagination -->
                              <div class="col-md-8 col-lg-6">
                                <div class="card shadow-lg">
                                  <div class="card-body">
                                    <h2 class="card-title text-center mb-4">Point History</h2>
                                    <div class="table-responsive">

                                      <table class="table ">
                                        <thead>
                                          <tr>
                                            <th>Date</th>
                                            <th>Category</th>
                                            <th>Description</th>
                                            <th>Points</th>
                                          </tr>
                                        </thead>
                                        <tbody id="pointHistoryList">
                                          <!-- Rows will be dynamically added here -->
                                        </tbody>
                                      </table>

                                    </div>
                                  </div>
                                </div>
                              </div>

                            
                         <!-- Rewards Card -->
                            <div class="col-md-12 col-lg-12">
                              <div class="card shadow-lg">
                                <div class="card-body">
                                 <div class="d-flex justify-content-center align-items-center mb-4 flex-wrap">
                                  <h2 class="card-title mb-0 me-3">Available Rewards</h2>
                                  <a href="redeem.html" class="btn btn-primary">Redeem Rewards</a>
                                 </div>
                                  <div id="rewardsList" class="row">

                                    <!-- Rewards will be dynamically added here -->
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          </div>

                    </div>
        </section>

 
 




        <!-- Footer-->
        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Copyright &copy; 2023 WAKA Space | 
                Made with <i class="bi bi-heart-fill"></i> by <a class="link-secondary" href="https://mind.in.th">Mind.in.th</a></p></div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>   

        <!-- Firebase Membership -->
        <script>

                const db = firebase.firestore();
                const auth = firebase.auth();

              document.addEventListener("DOMContentLoaded", function() {

                const userEmailField = document.getElementById('userEmail');
                const displayNameField = document.getElementById('displayName');
                const displayAkaField = document.getElementById('displayAka');
                const userPointsField = document.getElementById('userPoints');
                const updateProfileForm = document.getElementById('updateProfileForm');
                const changePasswordForm = document.getElementById('changePasswordForm');
                const logoutButton = document.getElementById('logout');
                const newPasswordField = document.getElementById('newPassword');
                const confirmNewPasswordField = document.getElementById('confirmNewPassword');
                const passwordMatchError = document.getElementById('passwordMatchError');
                const passwordLengthError = document.getElementById('passwordLengthError');
                const pointHistoryList = document.getElementById('pointHistoryList');
                const pageSize = 5; // Number of records per page
                let lastVisible = null;
                let firstVisible = null;

                // Fetch and display user data
                auth.onAuthStateChanged(user => {
                  if (user) {
                    userEmailField.textContent = user.email;
                    const userRef = db.collection('users').doc(user.uid);
                    
                    userRef.get().then(doc => {
                      if (doc.exists) {
                        const userData = doc.data();
                        userPointsField.textContent = userData.points;
                        displayNameField.textContent = userData.fullName;
                        displayAkaField.textContent = userData.aka;
                        document.getElementById('profileName').value = userData.fullName;
                        document.getElementById('profileAka').value = userData.aka;
                        // Load Point History after fetching user data
                        loadPointHistory(user.uid);
                      }
                    }).catch(error => {
                      console.error("Error fetching user data:", error);
                    });
                  } else {
                    window.location.href = "login.html"; // Redirect to login if not logged in
                  }
                });

                // Update Profile Name and AKA
                updateProfileForm.addEventListener('submit', function(e) {
                  e.preventDefault();
                  const newProfileName = document.getElementById('profileName').value;
                  const newAka = document.getElementById('profileAka').value;
                  
                  if (auth.currentUser) {
                    const userRef = db.collection('users').doc(auth.currentUser.uid);
                    userRef.update({
                      fullName: newProfileName,
                      aka: newAka
                    }).then(() => {
                      alert("Profile updated successfully!");
                      displayNameField.textContent = newProfileName;
                      displayAkaField.textContent = newAka;
                    }).catch(error => {
                      console.error("Error updating profile:", error);
                      alert("Error updating profile.");
                    });
                  }
                });

                // Real-time password length and matching check
                newPasswordField.addEventListener('input', function() {
                  if (newPasswordField.value.length < 6) {
                    passwordLengthError.style.display = "inline"; // Show error if password is too short
                  } else {
                    passwordLengthError.style.display = "none"; // Hide error when password meets length
                  }
                  checkPasswordMatch(); // Check match in real time as well
                });

                confirmNewPasswordField.addEventListener('input', checkPasswordMatch);

                function checkPasswordMatch() {
                  if (newPasswordField.value !== confirmNewPasswordField.value) {
                    passwordMatchError.style.display = "inline"; // Show error if passwords don't match
                  } else {
                    passwordMatchError.style.display = "none"; // Hide error when passwords match
                  }
                }

                // Change Password
                changePasswordForm.addEventListener('submit', function(e) {
                  e.preventDefault();
                  const currentPassword = document.getElementById('currentPassword').value;
                  const newPassword = newPasswordField.value;
                  const confirmNewPassword = confirmNewPasswordField.value;

                  // Final checks before submission
                  if (newPassword.length < 6) {
                    passwordLengthError.style.display = "inline";
                    return;
                  }

                  if (newPassword !== confirmNewPassword) {
                    passwordMatchError.style.display = "inline";
                    return;
                  }

                  // Reauthenticate and change password
                  const user = auth.currentUser;
                  const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                  
                  user.reauthenticateWithCredential(credential).then(() => {
                    return user.updatePassword(newPassword);
                  }).then(() => {
                    alert("Password changed successfully!");
                    
                    // Clear password fields after successful password change
                    document.getElementById('currentPassword').value = '';
                    newPasswordField.value = '';
                    confirmNewPasswordField.value = '';
                  }).catch(error => {
                    console.error("Error changing password:", error);
                    if (error.code === "auth/wrong-password") {
                      alert("Incorrect current password.");
                    } else if (error.code === "auth/requires-recent-login") {
                      alert("Please log out and log back in to change your password.");
                    } else {
                      alert("Error changing password.");
                    }
                  });
                });


                  // Log Out
                  document.getElementById('logout').addEventListener('click', function () {
                    auth.signOut().then(() => {
                      window.location.href = "login.html";
                    });
                  });


                  // Function to load all point history
                  function loadPointHistory(userId) {
                    console.log("Loading point history for userId:", userId); // Debugging

                    db.collection("pointHistory")
                      .where("userId", "==", userId)
                      .orderBy("date", "desc")
                      .get()
                      .then(snapshot => {
                        const pointHistoryList = document.getElementById('pointHistoryList');
                        pointHistoryList.innerHTML = ""; // Clear the table body

                        if (snapshot.empty) {
                          console.warn("No point history records found for userId:", userId);
                          const emptyRow = document.createElement("tr");
                          const emptyCell = document.createElement("td");
                          emptyCell.colSpan = 3;
                          emptyCell.textContent = "No records available.";
                          emptyRow.appendChild(emptyCell);
                          pointHistoryList.appendChild(emptyRow);
                          return;
                        }

                        // Render each transaction as a table row
                        snapshot.forEach(doc => {
                          const transaction = doc.data();
                          console.log("Transaction data:", transaction); // Debugging

                          const row = document.createElement("tr");

                          // Date cell
                          const dateCell = document.createElement("td");
                          const date = transaction.date.toDate();
                          const options = { day: '2-digit', month: 'short', year: '2-digit' };
                          dateCell.textContent = date.toLocaleDateString('en-GB', options);
                          row.appendChild(dateCell);


                          // Category cell
                          const categoryCell = document.createElement("td");
                          categoryCell.textContent = transaction.category || "N/A";
                          row.appendChild(categoryCell);                            

                          // Description cell
                          const descriptionCell = document.createElement("td");
                          descriptionCell.textContent = transaction.description || "N/A";
                          row.appendChild(descriptionCell);

                          // Points cell
                          const pointsCell = document.createElement("td");
                          pointsCell.textContent = transaction.points;

                          // Assign class based on whether points are positive or negative
                          if (transaction.points > 0) {
                            pointsCell.classList.add("points-add");
                          } else if (transaction.points < 0) {
                            pointsCell.classList.add("points-redeem");
                          }
                          row.appendChild(pointsCell);

                          // Append row to the table body
                          pointHistoryList.appendChild(row);
                        });
                      })
                      .catch(error => {
                        console.error("Error fetching point history:", error);
                        const pointHistoryList = document.getElementById('pointHistoryList');
                        pointHistoryList.innerHTML = "<tr><td colspan='3'>Error loading data. Please try again later.</td></tr>";
                      });
                  }


  // Call loadRewards to fetch and display rewards
  loadRewards();





//closing DOM
              });  




            function loadRewards() {
              const rewardsList = document.getElementById('rewardsList');

              // Fetch rewards that are available
              db.collection("rewards").where("available", "==", true).get().then(querySnapshot => {
                const rewards = [];
                querySnapshot.forEach(doc => {
                  const reward = doc.data();
                  console.log("Fetched reward:", reward); // Log reward details
                  rewards.push(reward);
                });

                // Pick 3 random rewards
                const randomRewards = rewards.sort(() => 0.5 - Math.random()).slice(0, 3);

                rewardsList.innerHTML = ""; // Clear existing rewards
                randomRewards.forEach(reward => {
                  const rewardCard = document.createElement("div");
                  rewardCard.className = "col-md-6 mb-3";

                  rewardCard.innerHTML = `
                    <div class="card border-secondary">
                      <img src="${reward.imageUrl}" class="card-img-top" alt="${reward.rewardName}">
                      <div class="card-body text-center">
                        <h5 class="card-title">${reward.rewardName}</h5>
                        <p class="card-text"><strong>Points: ${reward.pointsRequired}</strong></p>
                      </div>
                    </div>
                  `;
                  rewardsList.appendChild(rewardCard);
                });
              }).catch(error => {
                console.error("Error fetching rewards:", error);
              });
}
        

      </script>

    </body>
</html>
