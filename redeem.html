<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>WAKA Project - Waka Membership Redemption</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-MZDWS9HT55"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-MZDWS9HT55');
        </script>
        <!-- Firebase SDK Version 8 (compatible with HTML files without modules) -->
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

          <script>
            // Replace with your own Firebase configuration
              const firebaseConfig = {
                apiKey: "AIzaSyBTSgKRGTqOw28xjZrnr4efEwS7aqJvNQA",
                authDomain: "wakaproject-membership.firebaseapp.com",
                projectId: "wakaproject-membership",
                storageBucket: "wakaproject-membership.firebasestorage.app",
                messagingSenderId: "298596177389",
                appId: "1:298596177389:web:f0402d6ff0ce34af0743e4",
                measurementId: "G-HQZL3STV40"
              };
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
          </script>
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light bg-white">
            <div class="container px-4 px-lg-5">
                
                <a class="navbar-brand" href="#!"><img src="assets/logo-white.jpg" class="navbar-brand" style="height: 55px"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><a class="nav-link" aria-current="page" href="./index.html">Pokemon</a></li>
                        <!-- <li class="nav-item"><a class="nav-link" href="./youngguns">Young Guns</a></li> -->
                        <li class="nav-item"><a class="nav-link" href="./bot">BoT</a></li>
                        <li class="nav-item"><a class="nav-link" href="./rewards.html">Rewards</a></li>
                        <li class="nav-item"><a class="nav-link active" href="./register.html">Register</a></li>
                        <!-- <li class="nav-item"><a class="nav-link" href="./contact">Contact</a></li> -->
                    </ul>

                     <span class="mytooltip tooltip-effect-1">
                        <span class="tooltip-item">
                            <a href="https://line.me/ti/g2/ESxNt_nMsHA83nov78pwfmxU8mxeQG7Hz2mc7A?utm_source=invitation&utm_medium=link_copy&utm_campaign=default" target="_blank">  
                                <button class="btn btn-outline-dark" type="submit">
                                Join Us
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-line" viewBox="0 0 16 16">
                                      <path d="M8 0c4.411 0 8 2.912 8 6.492 0 1.433-.555 2.723-1.715 3.994-1.678 1.932-5.431 4.285-6.285 4.645-.83.35-.734-.197-.696-.413l.003-.018.114-.685c.027-.204.055-.521-.026-.723-.09-.223-.444-.339-.704-.395C2.846 12.39 0 9.701 0 6.492 0 2.912 3.59 0 8 0ZM5.022 7.686H3.497V4.918a.156.156 0 0 0-.155-.156H2.78a.156.156 0 0 0-.156.156v3.486c0 .041.017.08.044.107v.001l.002.002.002.002a.154.154 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157Zm.791-2.924a.156.156 0 0 0-.156.156v3.486c0 .086.07.155.156.155h.562c.086 0 .155-.07.155-.155V4.918a.156.156 0 0 0-.155-.156h-.562Zm3.863 0a.156.156 0 0 0-.156.156v2.07L7.923 4.832a.17.17 0 0 0-.013-.015v-.001a.139.139 0 0 0-.01-.01l-.003-.003a.092.092 0 0 0-.011-.009h-.001L7.88 4.79l-.003-.002a.029.029 0 0 0-.005-.003l-.008-.005h-.002l-.003-.002-.01-.004-.004-.002a.093.093 0 0 0-.01-.003h-.002l-.003-.001-.009-.002h-.006l-.003-.001h-.004l-.002-.001h-.574a.156.156 0 0 0-.156.155v3.486c0 .086.07.155.156.155h.56c.087 0 .157-.07.157-.155v-2.07l1.6 2.16a.154.154 0 0 0 .039.038l.001.001.01.006.004.002a.066.066 0 0 0 .008.004l.007.003.005.002a.168.168 0 0 0 .01.003h.003a.155.155 0 0 0 .04.006h.56c.087 0 .157-.07.157-.155V4.918a.156.156 0 0 0-.156-.156h-.561Zm3.815.717v-.56a.156.156 0 0 0-.155-.157h-2.242a.155.155 0 0 0-.108.044h-.001l-.001.002-.002.003a.155.155 0 0 0-.044.107v3.486c0 .041.017.08.044.107l.002.003.002.002a.155.155 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156Z"/>
                                    </svg>
                                </button>
                            </a>
                        </span>
                        <span class="tooltip-content clearfix">
                            <img src="assets/QrCode.jpg" loading="lazy">
                        </span>
                     </span>
                  
        
                </div>
            </div>
        </nav>

  
        <!-- Section 1-->
        <section class="py-5 bg-light gallery">
                    <div class="col-md-12 text-center">
                        
                        <h1 class="display-5 fw-bolder">Redeem your WAKA Rewards</h1>

                          <div class="container my-5">
                            <div class="row justify-content-center">

                              <div class="col-md-9 col-lg-9">
                                <div class="card shadow-lg">
                                  <div class="card-body">
                                    <h2 class="card-title text-center mb-4">Available Rewards</h2>

                                      <div class="card-body">
                                        <h5 class="card-title">Your Remaining Points</h5>
                                        <p class="card-text"><strong id="userPoints">Loading...</strong> points</p>
                                      </div>

                                        <div id="allRewardsList" class="row">
                                  </div>

  
                              </div>


                            </div>

                                <!-- Redemption History -->
                                <div class="card">
                                  <div class="card-body">
                                    <h2 class="card-title">Redemption History</h2>
                                      <div class="table-responsive">

                                        <table class="table ">
                                          <thead>
                                            <tr>
                                              <th>Date</th>
                                              <th>Description</th>
                                              <th>Points</th>
                                            </tr>
                                          </thead>
                                          <tbody id="redemptionHistoryList">
                                            <!-- Rows will be dynamically added here -->
                                          </tbody>
                                        </table>

                                    </div>



                                  </div>
                                </div>
                                
                          </div>

                        </div>
                      </div>
                    </div>
                  </section>



        <!-- Redemption Confirmation Modal -->
        <div class="modal fade" id="redeemModal" tabindex="-1" aria-labelledby="redeemModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="redeemModalLabel">Confirm Redemption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body text-center">
                <img id="modalRewardImage" src="" alt="Reward Image" class="img-fluid mb-3" style="max-height: 200px;">
                <p><strong>Reward:</strong> <span id="modalRewardName"></span></p>
                <p><strong>Points Required:</strong> <span id="modalPointsRequired"></span></p>
                <p><strong>Remaining Points:</strong> <span id="modalRemainingPoints"></span></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmRedeem" class="btn btn-primary">Confirm</button>
              </div>
            </div>
          </div>
        </div>




        <!-- Footer-->
        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white">Copyright &copy; 2023 WAKA Space | 
                Made with <i class="bi bi-heart-fill"></i> by <a class="link-secondary" href="https://mind.in.th">Mind.in.th</a></p></div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>   

        <!-- Firebase Membership -->
        <script>
          // Global Variables
          const db = firebase.firestore();
          const auth = firebase.auth();
          let userPoints = 0; // Store user's points for redemption checks

          // Helper Functions

          // Load user points
          function loadUserPoints(userId) {
            const userPointsField = document.getElementById('userPoints');

            db.collection('users').doc(userId).get().then(doc => {
              if (doc.exists) {
                userPoints = doc.data().points;
                userPointsField.textContent = `${userPoints} points`;
              } else {
                userPointsField.textContent = "No points available.";
              }
            }).catch(error => {
              console.error("Error fetching user points:", error);
              userPointsField.textContent = "Error loading points.";
            });
          }

          // Update redemption history
          function updateRedemptionHistory(userId) {
            const redemptionHistoryList = document.getElementById('redemptionHistoryList');

            db.collection('pointHistory')
              .where('userId', '==', userId)
              .where('category', '==', 'Rewards Redemption')
              .orderBy('date', 'desc')
              .get()
              .then(querySnapshot => {
                redemptionHistoryList.innerHTML = ""; // Clear existing history
                if (querySnapshot.empty) {
                  redemptionHistoryList.innerHTML = `
                    <tr>
                      <td colspan="3" class="text-center">No redemption history available.</td>
                    </tr>
                  `;
                } else {
                  querySnapshot.forEach(doc => {
                    const history = doc.data();
                    const date = new Date(history.date.seconds * 1000).toLocaleDateString('en-GB');
                    const historyRow = `
                      <tr>
                        <td>${date}</td>
                        <td>${history.description}</td>
                        <td>${history.points}</td>
                      </tr>
                    `;
                    redemptionHistoryList.insertAdjacentHTML("beforeend", historyRow);
                  });
                }
              })
              .catch(error => {
                console.error("Error updating redemption history:", error);
              });
          }

          // Update available rewards
          function updateAvailableRewards() {
            const allRewardsList = document.getElementById('allRewardsList');

              db.collection("rewards").where("available", "==", true).get().then((querySnapshot) => {
                allRewardsList.innerHTML = ""; // Clear existing rewards
                querySnapshot.forEach((doc) => {
                  const reward = { ...doc.data(), id: doc.id }; // Include reward ID for referencing
                  if (reward.stock <= 0) return; // Skip out-of-stock rewards

                  const rewardCard = `
                    <div class="col-md-4 mb-3">
                      <div class="card border-secondary">
                        <img src="${reward.imageUrl}" class="card-img-top" alt="${reward.rewardName}">
                        <div class="card-body text-center">
                          <h5 class="card-title">${reward.rewardName}</h5>
                          <p class="card-text">Points: ${reward.pointsRequired}</p>
                          <button class="btn btn-primary redeem-btn" data-id="${doc.id}">Redeem</button>
                        </div>
                      </div>
                    </div>
                  `;
                  allRewardsList.insertAdjacentHTML("beforeend", rewardCard);

                  // Attach event listener to redeem button
                  document.querySelector(`button[data-id="${doc.id}"]`).addEventListener("click", () => {
                    showRedemptionModal(reward);
                  });
                });
              }).catch((error) => {
                console.error("Error loading rewards:", error);
              });
            }

          // Main Functions

          // Show redemption confirmation modal
          function showRedemptionModal(reward) {
            const modalRewardName = document.getElementById('modalRewardName');
            const modalPointsRequired = document.getElementById('modalPointsRequired');
            const modalRemainingPoints = document.getElementById('modalRemainingPoints');
            const modalRewardImage = document.getElementById('modalRewardImage'); // Image element
            const confirmRedeemButton = document.getElementById('confirmRedeem');
            const modalElement = document.getElementById('redeemModal');

            // Populate modal content
            modalRewardName.textContent = reward.rewardName;
            modalPointsRequired.textContent = reward.pointsRequired;
            modalRemainingPoints.textContent = userPoints - reward.pointsRequired;
            modalRewardImage.src = reward.imageUrl || "placeholder.jpg"; // Use a placeholder if no image is provided

            // Clear previous event listeners
            const newConfirmButton = confirmRedeemButton.cloneNode(true);
            confirmRedeemButton.parentNode.replaceChild(newConfirmButton, confirmRedeemButton);

            // Attach a single click listener
            newConfirmButton.addEventListener('click', () => {
              if (reward.stock <= 0) {
                alert("Sorry, this reward is out of stock.");
                return;
              }
              redeemReward(reward);
              const redeemModal = bootstrap.Modal.getInstance(modalElement);
              redeemModal.hide();
            });

            // Show the modal
            const redeemModal = new bootstrap.Modal(modalElement, {
              backdrop: 'static',
              keyboard: true,
            });
            redeemModal.show();
          }




          // Redeem reward
          function redeemReward(reward) {
            const userId = firebase.auth().currentUser.uid;
            const rewardRef = db.collection('rewards').doc(reward.id); // Reference to the reward document
            const userRef = db.collection('users').doc(userId);
            const pointHistoryRef = db.collection('pointHistory').doc();

            db.runTransaction(async (transaction) => {
              const rewardDoc = await transaction.get(rewardRef);
              const userDoc = await transaction.get(userRef);

              if (!rewardDoc.exists) throw "Reward not found!";
              if (!userDoc.exists) throw "User not found!";

              const rewardData = rewardDoc.data();
              const userData = userDoc.data();

              // Check stock availability
              if (rewardData.stock <= 0) throw "Out of stock!";
              // Check points availability
              if (userData.points < reward.pointsRequired) throw "Insufficient points!";

              // Deduct points and stock
              transaction.update(userRef, {
                points: userData.points - reward.pointsRequired,
              });
              transaction.update(rewardRef, {
                stock: rewardData.stock - 1,
              });

              // Add redemption to pointHistory
              transaction.set(pointHistoryRef, {
                userId: userId,
                date: new Date(),
                category: 'Rewards Redemption',
                description: reward.rewardName,
                points: -reward.pointsRequired,
              });
            })
              .then(() => {
                alert("Reward redeemed successfully!");
                updateRedemptionHistory(userId);
                updateAvailableRewards(); // Refresh rewards dynamically
                document.getElementById("userPoints").textContent = `${userPoints - reward.pointsRequired} points`;
              })
              .catch((error) => {
                console.error("Error redeeming reward:", error);
                alert(error);
              });
          }




          // Load all rewards
          function loadAllRewards() {
            const userId = auth.currentUser.uid;
            loadUserPoints(userId);
            updateAvailableRewards();
            updateRedemptionHistory(userId);
          }

          // Initialization

          document.addEventListener("DOMContentLoaded", () => {
            auth.onAuthStateChanged(user => {
              if (user) {
                loadAllRewards();
              } else {
                console.error("User not logged in.");
              }
            });
          });


        </script>

    </body>
</html>
